---
title: "Compile Filtered Dataset - R Notebook"
authors:  Rebecca Ross and Genoveva Gonzalez Mirelis
date: "Last Rendered on `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_notebook: 
    toc: yes
    toc_depth: 2
    toc_float: yes
    fig_width: 7
    fig_height: 7
always_allow_html: true 
---

#Assumptions
This script allows you to run species/ station filters/ any other filters in what ever order suits you, then compile the final objects here to ensure you are getting the up-to-date filters applied.

Assumes:
- pre run config
- pre run Filters scripts


#Libraries
```{r}
library(dplyr)
library(tidyr)
```
#inputs
Loaded from file to ensure stable random subsample - check dates are correct version

```{r}
activeSppFilter<-read.csv(file.path(dataPath,"activeSpeciesfilter_2022-09-13.csv"))
activeStFilter<-read.csv(file.path(dataPath,"activeSubsample_2022-09-13.csv"))

```


#Combine filters to form dataset

Use output of stationFilters (sample_info_f_ss) to select from filtered species data (sel.sppDens)
```{r}
stFilt.sel.sppDens<-activeSppFilter%>% filter(SampID%in%activeStFilter$SampID) 

#check effect
length(unique(activeSppFilter$SampID)) # number of samples in sp filtered dataset
length(unique(stFilt.sel.sppDens$SampID)) # number of samples in station filtered sp filtered dataset 
```

#Change to wide format for analyses

```{r}
#temporary code to make working object - ensure use specLT1 object later
wideData <- stFilt.sel.sppDens %>% select(-c(TotAbu_pseudocount)) %>%
  mutate(clean_taxonomy = gsub(" ","_",clean_taxonomy)) %>%
 # mutate(clean_taxonomy = gsub("\\..*","",clean_taxonomy, fixed=FALSE)) %>%#removes whats after the ;
  pivot_wider(names_from = clean_taxonomy, values_from = density_n100m2, values_fill = 0, values_fn = sum)%>%
  select("SampID",sort(colnames(.))) #nice to have the cols alphabetical

head(wideData)

```

#output dataset
```{r}
write.csv(wideData, file=file.path(dataPath,(paste0("widedata_", Sys.Date(),".csv"))))
```

# ALIGN ENV dataset to final selection of samples
```{r}
envData<-read.csv(file.path(dataPath,"samples_env.csv"))

envData_f<-envData%>% filter(SampID%in%wideData$SampID) 

write.csv(envData_f, file=file.path(dataPath,(paste0("envData_", Sys.Date(),".csv"))))
```

